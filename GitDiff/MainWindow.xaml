<Window x:Class="GitDiff.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:vm="clr-namespace:GitDiff.ViewModels"
        xmlns:converters="clr-namespace:GitDiff.Converters"
        mc:Ignorable="d"
        Title="Git Diff Extractor"
        Height="800" Width="1100"
        MinHeight="600" MinWidth="800"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource MaterialDesign.Brush.Background}"
        FontFamily="{materialDesign:MaterialDesignFont}">

    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <Window.Resources>
        <converters:StatusToColorConverter x:Key="StatusToColorConverter" />
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:NullToBoolConverter x:Key="NullToBoolConverter" />
        <converters:CommitRoleConverter x:Key="CommitRoleConverter" />
    </Window.Resources>

    <DockPanel LastChildFill="True">
        <!-- Top toolbar: Repository path + filters in one compact row -->
        <ToolBarTray DockPanel.Dock="Top" IsLocked="True">
            <ToolBar Band="0" BandIndex="0" ClipToBounds="True"
                     Style="{DynamicResource MaterialDesignToolBar}">
                <materialDesign:PackIcon Kind="Git" Width="20" Height="20" VerticalAlignment="Center" />
                <TextBox Text="{Binding RepositoryPath, UpdateSourceTrigger=PropertyChanged}"
                         materialDesign:HintAssist.Hint="リポジトリパス"
                         materialDesign:TextFieldAssist.HasClearButton="True"
                         Width="360"
                         VerticalAlignment="Center"
                         Margin="4,0" />
                <Button Command="{Binding BrowseRepositoryCommand}"
                        Content="参照"
                        Style="{StaticResource MaterialDesignFlatButton}"
                        Padding="8,4" Height="28" />
                <Separator />
                <materialDesign:PackIcon Kind="AccountFilter" VerticalAlignment="Center" Width="18" Height="18" />
                <ComboBox ItemsSource="{Binding Committers}"
                          SelectedItem="{Binding SelectedCommitter}"
                          materialDesign:HintAssist.Hint="Committer"
                          IsEditable="False"
                          Width="150"
                          VerticalAlignment="Center"
                          Margin="4,0">
                    <ComboBox.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="クリア" Click="ClearCommitterFilter_Click" />
                        </ContextMenu>
                    </ComboBox.ContextMenu>
                </ComboBox>
                <materialDesign:PackIcon Kind="FolderSearch" VerticalAlignment="Center" Width="18" Height="18" Margin="4,0,0,0" />
                <TextBox Text="{Binding FolderFilter, UpdateSourceTrigger=PropertyChanged, Delay=300}"
                         materialDesign:HintAssist.Hint="フォルダ絞り込み"
                         materialDesign:TextFieldAssist.HasClearButton="True"
                         Width="160"
                         VerticalAlignment="Center"
                         Margin="4,0" />
            </ToolBar>
        </ToolBarTray>

        <!-- Status Bar -->
        <StatusBar DockPanel.Dock="Bottom">
            <StatusBar.ItemsPanel>
                <ItemsPanelTemplate>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                    </Grid>
                </ItemsPanelTemplate>
            </StatusBar.ItemsPanel>
            <StatusBarItem Grid.Column="0">
                <TextBlock Text="{Binding StatusMessage}" />
            </StatusBarItem>
            <StatusBarItem Grid.Column="1">
                <TextBlock Text="{Binding DiffFileCount, StringFormat='Diff: {0} files'}" Margin="0,0,8,0" />
            </StatusBarItem>
            <StatusBarItem Grid.Column="2">
                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                             IsIndeterminate="True"
                             Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"
                             Value="0"
                             Width="16" Height="16" />
            </StatusBarItem>
        </StatusBar>

        <!-- Main content: Commits (top) + DiffFiles (bottom) with splitter -->
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="3*" MinHeight="120" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="2*" MinHeight="100" />
            </Grid.RowDefinitions>

            <!-- Commits -->
            <DockPanel Grid.Row="0">
                <TextBlock DockPanel.Dock="Top" Text="Commits" FontWeight="SemiBold" FontSize="12"
                           Margin="4,2,4,2" />
                <DataGrid x:Name="CommitsGrid"
                          ItemsSource="{Binding Commits}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          SelectionMode="Extended"
                          PreviewMouseLeftButtonDown="CommitsGrid_PreviewMouseLeftButtonDown"
                          CanUserSortColumns="True"
                          CanUserResizeColumns="True"
                          HeadersVisibility="Column"
                          GridLinesVisibility="Horizontal"
                          BorderThickness="1"
                          BorderBrush="{DynamicResource MaterialDesign.Brush.TextBox.HoverBackground}"
                          RowHeight="28"
                          FontSize="12">
                    <DataGrid.Columns>
                        <DataGridTemplateColumn Header="" Width="48" CanUserSort="False" CanUserResize="False">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock FontWeight="Bold" FontSize="10" HorizontalAlignment="Center"
                                               VerticalAlignment="Center" Padding="2,0">
                                        <TextBlock.Text>
                                            <MultiBinding Converter="{StaticResource CommitRoleConverter}">
                                                <Binding />
                                                <Binding Path="DataContext.BaseCommit" RelativeSource="{RelativeSource AncestorType=DataGrid}" />
                                                <Binding Path="DataContext.TargetCommit" RelativeSource="{RelativeSource AncestorType=DataGrid}" />
                                            </MultiBinding>
                                        </TextBlock.Text>
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Style.Triggers>
                                                    <Trigger Property="Text" Value="Base">
                                                        <Setter Property="Foreground" Value="{DynamicResource PrimaryHueMidBrush}" />
                                                    </Trigger>
                                                    <Trigger Property="Text" Value="Target">
                                                        <Setter Property="Foreground" Value="{DynamicResource SecondaryHueMidBrush}" />
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="Hash" Binding="{Binding ShortHash}" Width="70" />
                        <DataGridTextColumn Header="Message" Binding="{Binding Message}" Width="*" />
                        <DataGridTextColumn Header="Author" Binding="{Binding Author}" Width="110" />
                        <DataGridTextColumn Header="Date" Binding="{Binding DateString}" Width="120" />
                    </DataGrid.Columns>
                </DataGrid>
            </DockPanel>

            <GridSplitter Grid.Row="1" Height="4" HorizontalAlignment="Stretch"
                          Background="{DynamicResource MaterialDesign.Brush.TextBox.HoverBackground}"
                          ResizeDirection="Rows" />

            <!-- Base/Target + Compare/Export bar -->
            <DockPanel Grid.Row="2" Margin="4,4,4,2">
                <Button DockPanel.Dock="Right"
                        Command="{Binding ExportCommand}"
                        Style="{StaticResource MaterialDesignRaisedButton}"
                        materialDesign:ButtonAssist.CornerRadius="3"
                        Padding="12,4" Height="30" Margin="4,0,0,0">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Export" Width="16" Height="16" Margin="0,0,4,0" />
                        <TextBlock Text="Export" />
                    </StackPanel>
                </Button>
                <Button DockPanel.Dock="Right"
                        Command="{Binding CompareCommand}"
                        Style="{StaticResource MaterialDesignRaisedSecondaryButton}"
                        materialDesign:ButtonAssist.CornerRadius="3"
                        Padding="12,4" Height="30" Margin="8,0,0,0">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Compare" Width="16" Height="16" Margin="0,0,4,0" />
                        <TextBlock Text="Compare" />
                    </StackPanel>
                </Button>

                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Base:" VerticalAlignment="Center" Margin="0,0,4,0" FontWeight="SemiBold" />
                    <TextBlock Text="{Binding BaseCommit.DisplayText, FallbackValue='(未選択)'}"
                               VerticalAlignment="Center"
                               Foreground="{DynamicResource PrimaryHueMidBrush}" />
                    <materialDesign:PackIcon Kind="ArrowRight" VerticalAlignment="Center" Margin="8,0" Width="18" Height="18" />
                    <TextBlock Text="Target:" VerticalAlignment="Center" Margin="0,0,4,0" FontWeight="SemiBold" />
                    <TextBlock Text="{Binding TargetCommit.DisplayText, FallbackValue='(未選択)'}"
                               VerticalAlignment="Center"
                               Foreground="{DynamicResource SecondaryHueMidBrush}" />
                </StackPanel>
            </DockPanel>

            <!-- Diff Files -->
            <DockPanel Grid.Row="3">
                <TextBlock DockPanel.Dock="Top" FontWeight="SemiBold" FontSize="12" Margin="4,2,4,2">
                    <Run Text="Diff Files" />
                    <Run Text="{Binding DiffFileCount, StringFormat='({0})'}" />
                </TextBlock>
                <DataGrid ItemsSource="{Binding DiffFiles}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          CanUserSortColumns="True"
                          CanUserResizeColumns="True"
                          HeadersVisibility="Column"
                          GridLinesVisibility="Horizontal"
                          BorderThickness="1"
                          BorderBrush="{DynamicResource MaterialDesign.Brush.TextBox.HoverBackground}"
                          FontSize="12">
                    <DataGrid.Columns>
                        <DataGridTemplateColumn Header="Status" Width="70" SortMemberPath="StatusText">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding StatusText}"
                                               Foreground="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                               FontWeight="Bold" FontSize="11" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="File Path" Binding="{Binding FilePath}" Width="*" />
                        <DataGridTextColumn Header="Old Path" Binding="{Binding OldPath}" Width="180" />
                    </DataGrid.Columns>
                </DataGrid>
            </DockPanel>
        </Grid>
    </DockPanel>
</Window>
