<Window x:Class="GitDiff.Views.DiffViewerWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:converters="clr-namespace:GitDiff.Converters"
        Title="{Binding WindowTitle}"
        Height="700" Width="1100"
        MinHeight="400" MinWidth="600"
        WindowStartupLocation="CenterOwner"
        Icon="pack://application:,,,/GitDiff.ico"
        Background="{DynamicResource MaterialDesign.Brush.Background}"
        FontFamily="{materialDesign:MaterialDesignFont}">

    <Window.Resources>
        <converters:DiffLineTypeToBackgroundConverter x:Key="DiffLineTypeToBackgroundConverter" />
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
    </Window.Resources>

    <Grid>
        <!-- Main Content -->
        <DockPanel>
            <!-- Header Bar -->
            <Border DockPanel.Dock="Top"
                    Background="{DynamicResource MaterialDesign.Brush.Card.Background}"
                    Padding="12,8" BorderThickness="0,0,0,1"
                    BorderBrush="{DynamicResource MaterialDesign.Brush.TextBox.HoverBackground}">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center">
                        <!-- View mode toggle -->
                        <Button Command="{Binding ToggleViewModeCommand}"
                                Style="{StaticResource MaterialDesignFlatButton}"
                                Height="26" Padding="8,2" Margin="0,0,12,0"
                                materialDesign:ButtonAssist.CornerRadius="3"
                                ToolTip="表示モード切替 (Unified / Side-by-Side)">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Width="16" Height="16" Margin="0,0,4,0"
                                                         VerticalAlignment="Center">
                                    <materialDesign:PackIcon.Style>
                                        <Style TargetType="materialDesign:PackIcon">
                                            <Setter Property="Kind" Value="ViewColumn" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsSideBySideMode}" Value="False">
                                                    <Setter Property="Kind" Value="ViewSequential" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </materialDesign:PackIcon.Style>
                                </materialDesign:PackIcon>
                                <TextBlock FontSize="11" VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="Side-by-Side" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsSideBySideMode}" Value="False">
                                                    <Setter Property="Text" Value="Unified" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>
                        </Button>
                        <TextBlock Text="{Binding FileStatus}" FontWeight="Bold" FontSize="12"
                                   Foreground="{DynamicResource SecondaryHueMidBrush}" Margin="0,0,12,0"
                                   VerticalAlignment="Center" />
                        <TextBlock FontSize="12" VerticalAlignment="Center">
                            <Run Text="{Binding DiffSummary}" Foreground="{DynamicResource PrimaryHueMidBrush}" />
                        </TextBlock>
                    </StackPanel>
                    <TextBlock Text="{Binding FilePath}" FontSize="13" FontWeight="SemiBold"
                               VerticalAlignment="Center" TextTrimming="CharacterEllipsis"
                               ToolTip="{Binding FilePath}" />
                </DockPanel>
            </Border>

            <!-- Commit Navigation Bar -->
            <Border DockPanel.Dock="Top"
                    Background="{DynamicResource MaterialDesign.Brush.Card.Background}"
                    Padding="8,4" BorderThickness="0,0,0,1"
                    BorderBrush="{DynamicResource MaterialDesign.Brush.TextBox.HoverBackground}"
                    Visibility="{Binding HasMultipleCommits, Converter={StaticResource BoolToVisibilityConverter}}">
                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                    <StackPanel Orientation="Horizontal">
                        <Button Command="{Binding SelectOverallCommand}"
                                Margin="0,0,4,0" Height="28" Padding="10,2"
                                materialDesign:ButtonAssist.CornerRadius="3">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignFlatButton}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsOverallSelected}" Value="True">
                                            <Setter Property="Background" Value="{DynamicResource PrimaryHueLightBrush}" />
                                            <Setter Property="Foreground" Value="{DynamicResource PrimaryHueDarkBrush}" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                            <TextBlock Text="Overall" FontSize="11" />
                        </Button>
                        <ItemsControl ItemsSource="{Binding FileCommits}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Command="{Binding DataContext.SelectCommitCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="{Binding TooltipText}"
                                            Margin="2,0" Height="28" Padding="10,2"
                                            materialDesign:ButtonAssist.CornerRadius="3">
                                        <Button.Style>
                                            <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignFlatButton}">
                                                <Style.Triggers>
                                                    <DataTrigger Value="True">
                                                        <DataTrigger.Binding>
                                                            <MultiBinding>
                                                                <MultiBinding.Converter>
                                                                    <converters:EqualityConverter />
                                                                </MultiBinding.Converter>
                                                                <Binding />
                                                                <Binding Path="DataContext.SelectedCommit" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                            </MultiBinding>
                                                        </DataTrigger.Binding>
                                                        <Setter Property="Background" Value="{DynamicResource PrimaryHueLightBrush}" />
                                                        <Setter Property="Foreground" Value="{DynamicResource PrimaryHueDarkBrush}" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                        <TextBlock Text="{Binding ShortMessage}" FontSize="11" />
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- Unified Diff Content -->
            <ListView ItemsSource="{Binding DiffLines}"
                      Visibility="{Binding IsSideBySideMode, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}"
                      VirtualizingStackPanel.IsVirtualizing="True"
                      VirtualizingStackPanel.VirtualizationMode="Recycling"
                      ScrollViewer.HorizontalScrollBarVisibility="Auto"
                      ScrollViewer.VerticalScrollBarVisibility="Auto"
                      BorderThickness="0"
                      FontFamily="Consolas" FontSize="12"
                      HorizontalContentAlignment="Stretch">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="Margin" Value="0" />
                        <Setter Property="MinHeight" Value="0" />
                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListViewItem">
                                    <Border Background="{Binding Type, Converter={StaticResource DiffLineTypeToBackgroundConverter}}"
                                            BorderThickness="0,0,0,0.5"
                                            BorderBrush="{DynamicResource MaterialDesign.Brush.TextBox.HoverBackground}">
                                        <ContentPresenter />
                                    </Border>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="50" />
                                <ColumnDefinition Width="50" />
                                <ColumnDefinition Width="16" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0"
                                       Text="{Binding OldLineNumber}"
                                       Foreground="{DynamicResource MaterialDesign.Brush.ForegroundLight}"
                                       TextAlignment="Right" Padding="4,1,6,1"
                                       FontSize="11" />
                            <TextBlock Grid.Column="1"
                                       Text="{Binding NewLineNumber}"
                                       Foreground="{DynamicResource MaterialDesign.Brush.ForegroundLight}"
                                       TextAlignment="Right" Padding="4,1,6,1"
                                       FontSize="11" />
                            <TextBlock Grid.Column="2" HorizontalAlignment="Center" Padding="0,1"
                                       FontSize="11">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Type}" Value="Added">
                                                <Setter Property="Text" Value="+" />
                                                <Setter Property="Foreground" Value="#4CAF50" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Type}" Value="Deleted">
                                                <Setter Property="Text" Value="-" />
                                                <Setter Property="Foreground" Value="#F44336" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            <TextBlock Grid.Column="3"
                                       Text="{Binding Content}"
                                       Padding="4,1" FontSize="12" />
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <!-- Side-by-Side Diff Content -->
            <Grid Visibility="{Binding IsSideBySideMode, Converter={StaticResource BoolToVisibilityConverter}}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="2" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- Left side (old file) -->
                <ListView x:Name="LeftDiffList" Grid.Column="0"
                          ItemsSource="{Binding SideBySideLines}"
                          VirtualizingStackPanel.IsVirtualizing="True"
                          VirtualizingStackPanel.VirtualizationMode="Recycling"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Hidden"
                          BorderThickness="0"
                          FontFamily="Consolas" FontSize="12"
                          HorizontalContentAlignment="Stretch">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="Padding" Value="0" />
                            <Setter Property="Margin" Value="0" />
                            <Setter Property="MinHeight" Value="0" />
                            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListViewItem">
                                        <Border Background="{Binding LeftType, Converter={StaticResource DiffLineTypeToBackgroundConverter}}"
                                                BorderThickness="0,0,0,0.5"
                                                BorderBrush="{DynamicResource MaterialDesign.Brush.TextBox.HoverBackground}">
                                            <ContentPresenter />
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="45" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0"
                                           Text="{Binding LeftLineNumber}"
                                           Foreground="{DynamicResource MaterialDesign.Brush.ForegroundLight}"
                                           TextAlignment="Right" Padding="4,1,6,1"
                                           FontSize="11" />
                                <TextBlock Grid.Column="1"
                                           Text="{Binding LeftContent}"
                                           Padding="4,1" FontSize="12" />
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <!-- Divider -->
                <Border Grid.Column="1"
                        Background="{DynamicResource MaterialDesign.Brush.TextBox.HoverBackground}" />

                <!-- Right side (new file) -->
                <ListView x:Name="RightDiffList" Grid.Column="2"
                          ItemsSource="{Binding SideBySideLines}"
                          VirtualizingStackPanel.IsVirtualizing="True"
                          VirtualizingStackPanel.VirtualizationMode="Recycling"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          BorderThickness="0"
                          FontFamily="Consolas" FontSize="12"
                          HorizontalContentAlignment="Stretch">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="Padding" Value="0" />
                            <Setter Property="Margin" Value="0" />
                            <Setter Property="MinHeight" Value="0" />
                            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListViewItem">
                                        <Border Background="{Binding RightType, Converter={StaticResource DiffLineTypeToBackgroundConverter}}"
                                                BorderThickness="0,0,0,0.5"
                                                BorderBrush="{DynamicResource MaterialDesign.Brush.TextBox.HoverBackground}">
                                            <ContentPresenter />
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="45" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0"
                                           Text="{Binding RightLineNumber}"
                                           Foreground="{DynamicResource MaterialDesign.Brush.ForegroundLight}"
                                           TextAlignment="Right" Padding="4,1,6,1"
                                           FontSize="11" />
                                <TextBlock Grid.Column="1"
                                           Text="{Binding RightContent}"
                                           Padding="4,1" FontSize="12" />
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </Grid>
        </DockPanel>

        <!-- Loading Overlay -->
        <Border Background="#80000000"
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                             IsIndeterminate="True" Value="0"
                             Width="40" Height="40" />
                <TextBlock Text="Loading..." Foreground="White" Margin="0,8,0,0"
                           HorizontalAlignment="Center" />
            </StackPanel>
        </Border>
    </Grid>
</Window>
